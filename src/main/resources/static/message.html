<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Judith - 문자 발송</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar Overlay (mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img src="images/logo-symbol-dark.png" alt="Judith">
                    <img src="images/logo-text-dark.png" alt="Judith" class="sidebar-logo-text">
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">메뉴</div>
                    <a href="main.html" class="nav-link">
                        <span class="icon">&#x1F3E0;</span>
                        <span>대시보드</span>
                    </a>
                    <a href="user.html" class="nav-link">
                        <span class="icon">&#x1F465;</span>
                        <span>부원 관리</span>
                    </a>
                    <a href="reservation.html" class="nav-link">
                        <span class="icon">&#x1F3AD;</span>
                        <span>공연</span>
                    </a>
                </div>

                <div class="nav-section admin-only">
                    <div class="nav-section-title">관리자</div>
                    <a href="season.html" class="nav-link">
                        <span class="icon">&#x1F4C5;</span>
                        <span>학기</span>
                    </a>
                    <a href="message.html" class="nav-link active">
                        <span class="icon">&#x1F4AC;</span>
                        <span>문자</span>
                    </a>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-menu">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">사용자</div>
                        <div class="user-role" id="userRole">부원</div>
                    </div>
                </div>
                <button class="btn btn-ghost btn-sm" onclick="showPasswordChangeModal()" style="width: 100%; margin-top: 8px;">
                    비밀번호 변경
                </button>
                <button class="btn btn-ghost btn-sm" onclick="logout()" style="width: 100%; margin-top: 4px;">
                    로그아웃
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Header -->
            <header class="top-header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">&#x2630;</button>
                    <h1 class="page-title">문자 발송</h1>
                </div>
                <div class="header-right"></div>
            </header>

            <!-- Page Container -->
            <div class="page-container">
                <div class="grid grid-cols-2" style="gap: 32px;">
                    <!-- Send Message Section -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">졸업생에게 문자 발송</h3>
                        </div>
                        <div class="card-body">
                            <form id="sendMessageForm" onsubmit="sendMessage(event)">
                                <div class="form-group">
                                    <label class="form-label required" for="messageContent">메시지 내용</label>
                                    <textarea class="form-textarea" id="messageContent"
                                              placeholder="졸업생에게 보낼 메시지를 입력하세요..."
                                              style="min-height: 200px;" required></textarea>
                                </div>
                                <div class="form-hint mb-24">
                                    이 메시지는 모든 졸업생에게 SMS로 발송됩니다.
                                </div>
                                <button type="submit" class="btn btn-primary btn-block btn-lg" id="sendBtn">
                                    전체 졸업생에게 발송
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Message History Section -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">발송 내역</h3>
                            <button class="btn btn-sm btn-outline" onclick="loadMessageHistory()">새로고침</button>
                        </div>
                        <div id="messageHistory">
                            <div class="loading"><div class="spinner"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Message Detail Modal -->
    <div class="modal-overlay" id="messageDetailModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">메시지 상세</h3>
                <button class="modal-close" onclick="closeModal('messageDetailModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="mb-24">
                    <label class="text-sm text-muted">메시지 내용</label>
                    <div class="card" style="margin-top: 8px; background: var(--gray-50);">
                        <div class="card-body" style="padding: 16px;">
                            <p id="detailContent" style="white-space: pre-wrap;"></p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 mb-24" style="gap: 16px;">
                    <div class="stat-card">
                        <div class="stat-icon success">&#x2714;</div>
                        <div class="stat-value" id="detailSuccess">0</div>
                        <div class="stat-label">성공</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: var(--danger-bg); color: var(--danger);">&#x2716;</div>
                        <div class="stat-value" id="detailFailed">0</div>
                        <div class="stat-label">실패</div>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-8" style="padding-bottom: 12px; border-bottom: 1px solid var(--border-light);">
                    <span class="text-secondary">발송 시간</span>
                    <span id="detailSentAt">-</span>
                </div>
                <div class="flex justify-between items-center" style="padding-bottom: 12px;">
                    <span class="text-secondary">총 수신자</span>
                    <span id="detailTotal">-</span>
                </div>

                <div id="detailFailures" class="mt-16"></div>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Check authentication and admin access
        if (!requireAuth()) {
            // Will redirect to login
        } else if (!isAdmin()) {
            showToast('관리자 권한이 필요합니다', 'error');
            setTimeout(() => {
                window.location.href = 'main.html';
            }, 1000);
        }

        // Update user info in sidebar
        const roleNames = {
            'ADMIN': '관리자', 'LEADER': '회장', 'PRODUCER': '연출',
            'PLANNER': '기획', 'ACTOR': '배우', 'STAFF': '스태프', 'EXTERNAL': '외부인'
        };

        const userName = getCurrentUserName();
        const userRole = getCurrentUserRole();
        const roleName = roleNames[userRole] || userRole;

        document.getElementById('userName').textContent = userName;
        document.getElementById('userRole').textContent = roleName;
        document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();

        // Mobile menu toggle
        const menuToggle = document.getElementById('menuToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('active');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
        });

        // Message functions
        async function sendMessage(e) {
            e.preventDefault();

            const content = document.getElementById('messageContent').value.trim();
            if (!content) {
                showToast('메시지 내용을 입력해주세요', 'error');
                return;
            }

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="spinner spinner-sm"></span> 발송 중...';

            try {
                await messageApi.send(content);
                showToast('메시지가 발송되었습니다!', 'success');
                document.getElementById('sendMessageForm').reset();
                loadMessageHistory();
            } catch (error) {
                showToast(error.message || '메시지 발송에 실패했습니다', 'error');
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = '전체 졸업생에게 발송';
            }
        }

        async function loadMessageHistory() {
            const container = document.getElementById('messageHistory');

            try {
                const response = await messageApi.getHistory();
                const messages = response.content || response;

                if (!messages || messages.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">&#x1F4AC;</div>
                            <h3>발송된 메시지 없음</h3>
                            <p>발송된 메시지가 여기에 표시됩니다.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="list">
                        ${messages.map(msg => `
                            <div class="list-item" onclick="showMessageDetail(${msg.id})" style="cursor: pointer;">
                                <div class="list-item-icon" style="background: var(--primary-bg); color: var(--primary);">
                                    &#x1F4E9;
                                </div>
                                <div class="list-item-content">
                                    <div class="list-item-title truncate" style="max-width: 200px;">
                                        ${escapeHtml(msg.content.substring(0, 50))}${msg.content.length > 50 ? '...' : ''}
                                    </div>
                                    <div class="list-item-subtitle">
                                        ${formatDate(msg.sentAt)} &bull; ${msg.successCount}/${msg.successCount + msg.failureCount} 발송 성공
                                    </div>
                                </div>
                                <span style="color: var(--text-muted);">&#x2192;</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading messages:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <p class="text-danger">발송 내역을 불러오는데 실패했습니다</p>
                        <button class="btn btn-secondary" onclick="loadMessageHistory()">다시 시도</button>
                    </div>
                `;
            }
        }

        async function showMessageDetail(id) {
            try {
                const msg = await messageApi.getById(id);

                document.getElementById('detailContent').textContent = msg.content;
                document.getElementById('detailSentAt').textContent = formatDate(msg.sentAt);
                document.getElementById('detailTotal').textContent = msg.successCount + msg.failureCount;
                document.getElementById('detailSuccess').textContent = msg.successCount;
                document.getElementById('detailFailed').textContent = msg.failureCount;

                // Show failure details if any
                const failuresDiv = document.getElementById('detailFailures');
                if (msg.failures && msg.failures.length > 0) {
                    failuresDiv.innerHTML = `
                        <div class="card" style="background: var(--danger-bg); border-color: var(--danger);">
                            <div class="card-header" style="border-bottom-color: rgba(239,68,68,0.2);">
                                <h4 class="card-title text-danger">발송 실패 목록</h4>
                            </div>
                            <div class="card-body">
                                <ul style="padding-left: 20px;">
                                    ${msg.failures.map(f => `<li>${escapeHtml(f)}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                } else {
                    failuresDiv.innerHTML = '';
                }

                openModal('messageDetailModal');
            } catch (error) {
                showToast('메시지 상세 정보를 불러오는데 실패했습니다', 'error');
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            return new Date(dateString).toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        loadMessageHistory();
        checkPasswordChangeNeeded();
    </script>
</body>
</html>
